{% extends "base.html" %}
{% load static %}

{% block title %}Indivíduos{% endblock %} 

{% block content %}

<div class="card">
  <div class="card-body text-bg-info p-3 text-center">
    <h3>Lista de Detentos</h3>
  </div>
</div>
<br>
<div class="container-fluid d-flex justify-content-between align-items-center mb-3">
    
    <form id="search-form" class="d-flex flex-grow-1 me-3" role="search" method="GET"> 
        <input 
            class="form-control me-2" 
            type="search" 
            placeholder="Pesquisa por nome ou alcunha" 
            aria-label="Search"
            name="q"
            id="search-input" 
            value="{{ request.GET.q|default:'' }}"
        />
        <div class="btn-group" role="group">
            <button class="btn btn-outline-success" type="submit">Pesquisar</button>
            <a href="{% url 'individuo_list' %}" class="btn btn-outline-secondary" title="Limpar Busca">
                Limpar
            </a>
        </div>
    </form>

    <a href="{% url 'individuo_add' %}" class="btn btn-primary" title="Adicionar Novo Indivíduo">
        + indivíduo
    </a>
</div>
<br>
<table class="table table-bordered table-sm">
  <thead class="table-dark text-center">
    <tr class="align-middle">
      <th>#</th>
      <th>Nome</th>
      <th>Data nasc</th>
      <th>Cód. Preso</th>
      <th>Orcrim</th>
      <th>Presídio</th>
      <th>Situação</th>
      <th>Ações</th>
    </tr>
  </thead>
  <tbody>
    {% for individuo in object_list %}
    <tr class="align-middle">
        <td>
          {% if individuo.foto %} {# Verifique se a imagem existe antes de tentar exibi-la #}
            <img src="{{ individuo.foto.url }}" alt="{{ individuo.nome }}" style="width: 50px; height: 50px; object-fit: cover;" class="img-thumbnail">
          {% else %}
            <span>Sem foto</span>
          {% endif %}
        </td>
        <td>
          <a href="{% url "individuo_detail" individuo.pk %}">{{ individuo.nome }}</a>
        </td>
        <td class="text-center">{{ individuo.data_nasc|date:"d/m/Y" }}</td>
        <td class="text-center">{{ individuo.codigo_detento }}</td>
        <td class="text-center">{{ individuo.orcrim }}</td>
        <td class="text-center">{{ individuo.casa_prisional }}</td>
        <td class="text-center">{{ individuo.get_situacao_penal_display }}</td>
        <td class="text-center">
            <a href="{% url 'individuo_edit' pk=individuo.pk %}"><i class="bi bi-pencil-square link-warning"></i></a>
            <a href="{% url 'individuo_delete' pk=individuo.pk %}"><i class="bi bi-person-x link-danger"></i></a>
        </td>
    </tr>
    {% empty %}
    <tr>
        <td colspan="2">Nenhum indivíduo encontrado.</td>
    </tr>
    {% endfor %}
</tbody>
</table>

{% if is_paginated %}
<nav aria-label="Paginação da Lista">
    <ul class="pagination justify-content-center">

        {% if page_obj.has_previous %}
            <li class="page-item">
                <a class="page-link" href="?{% if request.GET.q %}q={{ request.GET.q }}&{% endif %}page={{ page_obj.previous_page_number }}" aria-label="Anterior">
                    <span aria-hidden="true">&laquo;</span> Anterior
                </a>
            </li>
        {% else %}
            <li class="page-item disabled">
                <span class="page-link"><span aria-hidden="true">&laquo;</span> Anterior</span>
            </li>
        {% endif %}

        {% for i in page_obj.paginator.page_range %}
            {% if page_obj.number == i %}
                <li class="page-item active" aria-current="page">
                    <span class="page-link">{{ i }}</span>
                </li>
            {% elif i > page_obj.number|add:'-3' and i < page_obj.number|add:'3' %}
                <li class="page-item">
                    <a class="page-link" href="?{% if request.GET.q %}q={{ request.GET.q }}&{% endif %}page={{ i }}">{{ i }}</a>
                </li>
            {% endif %}
        {% endfor %}

        {% if page_obj.has_next %}
            <li class="page-item">
                <a class="page-link" href="?{% if request.GET.q %}q={{ request.GET.q }}&{% endif %}page={{ page_obj.next_page_number }}" aria-label="Próxima">
                    Próxima <span aria-hidden="true">&raquo;</span>
                </a>
            </li>
        {% else %}
            <li class="page-item disabled">
                <span class="page-link">Próxima <span aria-hidden="true">&raquo;</span></span>
            </li>
        {% endif %}
    </ul>
</nav>

<div class="text-center mb-4">
    <small>Página {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}. Total de {{ page_obj.paginator.count }} detentos.</small>
</div>
{% endif %}

{% block extra_body_js %}
<script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('search-input');
    const form = document.querySelector('.d-flex');
    
    // 1. Damos um ID ao input para o JS encontrar ele facilmente
    if (searchInput) {
        searchInput.addEventListener('input', function() {
            // Se o valor do campo de busca estiver vazio (após remover espaços)
            if (this.value.trim() === '') {
                // Limpa o formulário e envia (ou simplesmente redireciona)
                
                // Opção mais simples: Envia o formulário com o campo vazio
                // A sua View já sabe tratar o campo vazio, retornando a lista completa.
                //form.submit();
                
                // OU, se você quiser apenas garantir que a URL volte ao estado base:
                window.location.href = window.location.pathname; 
            }
        });
    }
});
</script>
{% endblock extra_body_js %}

{% endblock content %}
